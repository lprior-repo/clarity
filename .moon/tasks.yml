$schema: "https://moonrepo.dev/schemas/tasks.json"

# Moon Task Configuration - Clarity Project
# All commands use cargo with system Rust toolchain

tasks:
  # ============================================================================
  # STAGE 1: CODE FORMATTING & LINTING
  # ============================================================================

  fmt:
    command: "cargo fmt --all --check"
    description: "Check code formatting (rustfmt)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "rustfmt.toml"
    options:
      cache: true
      runInCI: true

  fmt-fix:
    command: "cargo fmt --all"
    description: "Auto-fix code formatting"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
    options:
      cache: false  # Never cache - always format

  clippy:
    command: "cargo clippy --workspace --all-targets -- -D warnings"
    description: "Lint with Clippy (strict mode, excludes integration-tests)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
      - ".clippy.toml"
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # STAGE 2: QUICK CHECKS (Fast Feedback)
  # ============================================================================

  quick:
    command: "cargo fmt --all --check && cargo clippy --workspace --all-targets -- -D warnings"
    description: "Fast format + lint check (cached, excludes integration-tests)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  check:
    command: "cargo check --workspace --all-targets"
    description: "Fast type check without building (excludes integration-tests)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  # ============================================================================
  # STAGE 3: TESTING
  # ============================================================================

  test:
    command: "cargo test --workspace --all-features"
    description: "Run all tests"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "clarity-*/tests/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true
    env:
      CARGO_BUILD_JOBS: "8"

  test-doc:
    command: "cargo test --doc --workspace"
    description: "Run documentation tests"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true

  test-unit:
    command: "cargo test --workspace --lib"
    description: "Run unit tests only"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  # ============================================================================
  # STAGE 4: BUILDING
  # ============================================================================

  build:
    command: "cargo build --workspace"
    description: "Build all crates (debug mode)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  release:
    command: "cargo build --workspace --release"
    description: "Build release binaries"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  # ============================================================================
  # STAGE 5: RUNNING
  # ============================================================================

  server:
    command: "cargo run -p clarity-server"
    description: "Run the Axum server"
    deps:
      - build-server
    options:
      cache: false
      runInCI: false

  client:
    command: "cargo run -p clarity-client"
    description: "Run the Dioxus client"
    deps:
      - build-client
    options:
      cache: false
      runInCI: false

  # ============================================================================
  # STAGE 6: OPTIMIZED BUILDS (LTO + PGO)
  # ============================================================================

  release-ci:
    command: "cargo build --workspace --profile ci"
    description: "Build release binaries with thin LTO (faster for CI)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  pgo-instrument:
    command: "cargo build --workspace --profile pgo-instrument"
    description: "Build with PGO instrumentation (step 1 of PGO workflow)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
      - ".cargo/config.toml"
    options:
      cache: false
      runInCI: false
    env:
      CARGO_PROFILE_PGO_INSTRUMENT_OVERRIDE_RUSTFLAGS: "-C profile-generate=pgo-data"

  pgo-profile:
    command: "sh .moon/scripts/pgo-workload.sh"
    description: "Run representative workload for PGO profiling (step 2)"
    options:
      cache: false
      runInCI: false

  pgo-optimize:
    command: "cargo build --workspace --profile pgo-optimized"
    description: "Build optimized binary using PGO profile data (step 3)"
    inputs:
      - "clarity-*/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
      - "pgo-data/**/*.profraw"
    options:
      cache: false
      runInCI: false
    env:
      CARGO_PROFILE_PGO_OPTIMIZED_OVERRIDE_RUSTFLAGS: "-C profile-use=pgo-data -C llvm-args=-pgo-warn-missing-function"

  pgo-build:
    description: "Complete PGO workflow: instrument, profile, and optimize"
    deps:
      - pgo-instrument
      - pgo-profile
      - pgo-optimize
    options:
      cache: false
      runInCI: false

  # ============================================================================
  # STAGE 7: FULL PIPELINE (CI)
  # ============================================================================

  ci:
    description: "Run full CI pipeline (format, lint, test)"
    deps:
      - fmt
      - clippy
      - test
      - test-doc
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # DATABASE OPERATIONS
  # ============================================================================

  db-migrate:
    command: "sqlx migrate run"
    description: "Run database migrations"
    inputs:
      - "clarity-core/migrations/**/*.sql"
      - "Cargo.toml"
    options:
      cache: false
      runInCI: false
    env:
      DATABASE_URL: "postgresql://localhost/clarity"

  db-migrate-add:
    command: "sqlx migrate add"
    description: "Create new migration"
    options:
      cache: false
      runInCI: false

  # ============================================================================
  # INDIVIDUAL CRATE BUILDS
  # ============================================================================

  build-core:
    command: "cargo build -p clarity-core"
    description: "Build clarity-core"
    inputs:
      - "clarity-core/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  build-server:
    command: "cargo build -p clarity-server"
    description: "Build clarity-server"
    inputs:
      - "clarity-server/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false
    env:
      CLARITY_CORE_PATH: "../clarity-core"

  build-client:
    command: "cargo build -p clarity-client"
    description: "Build clarity-client"
    inputs:
      - "clarity-client/src/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false
    env:
      CLARITY_CORE_PATH: "../clarity-core"
